---
title: 载谈 Binomial Sum 的一个简易解释
tags: ["数学"]
categories: "算法笔记"
mathjax: true
---

洛谷日报你就是个**，还用人话说出来，EI 原文比你人话多了（恼。

关于形如 $\sum_{i=0}^kF_iG(i)$ 的一类求和问题，在 $G(i)$ 为 $n$ 次多项式时我们能做到的一个理论下界结果，以及一类特殊的函数复合问题。

参考：

- [「实验性讲稿」载谭 Binomial Sums 详解](https://www.luogu.com.cn/blog/EntropyIncreaser/review-binomial-sums)
- [载谭 Binomial Sum：多项式复合、插值与泰勒展开](https://www.luogu.com.cn/blog/EntropyIncreaser/zai-tan-binomial-sum-duo-xiang-shi-fu-ge-cha-zhi-yu-tai-lei-zhan-kai)

不建议阅读：

- [把EI科技 【载谈 Binomial Sum】 用人话说出来](https://www.luogu.com.cn/blog/lmpp/post-zai-tan-binomial-sum)

<!--more-->

### 引入

如果您仅仅希望得到开头我们所介绍的问题的解法，可以跳过本部分内容。

我们现在希望解决一类形如 $\sum_{x=0}^kf_xg(x)$ 的问题，其中 $g(x)$ 为关于 $x$ 的 $n$ 次多项式。我们希望，对于这类问题，我们都能找到一个在给出足够好的输入的前提下，以 $O(n)$ 时间完成的解法。

现在让我们来考虑两个已经得到解决的基本问题：幂和问题 $\sum_{x=0}^{k-1}x^n$，和由 ```min_25``` 给出解法的 ```Binomial Sum``` 问题 $\sum_{x=0}^{k}{k\choose x}x^n$。

首先是幂和问题，我们已经有一个 $O(n)$ 做法。其第一步是把 $x^n$ 看做一般的 $n$ 次多项式 $p(x)$，而后就有 $q(x)=\sum_{y=0}^{x-1}p(y)$ 是 $n+1$ 次多项式。于是我们只需要求出 $q$ 的连续点值，而后应用线性插值即可。

若要推广到一般的多项式 $p(x)$，困难在于在 $O(n)$ 时间之内求出其部分和的点值，也就是快速求出 $p$ 的若干值。因而，若 $p$ 以点值的形式给出，我们就解决了这个问题，而若以多项式基的形式给出，我们就需要对每个 $x^i$ 都计算其前缀和。

这让我们想起生成函数。我们注意到 $x^i=[\frac{z^i}{i!}]\exp(xz)$，那么在一般的合式里我们希望计算的也就是 $[\frac{z^i}{i!}]\sum_xf_x\exp(xz)$，若 $\{f_x\}$ 有生成函数 $F$，那么我们所需要求的也就是 $F(\exp(x))$。这里也就是我们所能做到的最好程度，在一般情况下我们并没有足够优秀的方法来计算这一复合。

现在让我们来看看 $\sum_{x=0}^{k}{k\choose x}x^n$。类似的，我们不妨直接写出它的 GF（经由二项式定理，这是简单的）为 $[\frac{z^n}{n!}](1+\exp z)^k$。

我们有一个基于斯特林数的方式，不妨把 $x^n$ 拆成下降幂。我们有 $x^n=\sum_j{n\brace j}j!{x\choose j}$。现在我们把两边同时加上生成函数——我们得到一个看起来没有任何用的结果：$\exp xz=((\exp z-1)+1)^x$。然而，这个恒等式将成为我们后面问题的一个重要枢纽。

现在，我们来看一些较为容易处理的问题。

我们先来解决贝尔数 $\exp(\exp z-1)$，思考如何 $O(n)$ 时间计算其第 $n$ 项。

让我们把 $\exp$ 按照定义式打开，我们就得到 $\sum_{i\ge 0}\frac{1}{i!}(\exp z-1)^i$。现在有一件好事：我们发现 $\exp z-1$ 的常数项是零，这意味着我们不必理会无穷和式，而可以把求和上界改成 $n$。现在让我们应用二项式定理，跳跃几步平凡的步骤，我们得到原式是
$$
[\frac{z^n}{n!}]\exp(\exp z-1)=\sum_{i\le n}\frac{1}{i!}i^n\sum_{j\le n-i}\frac{(-1)^j}{j!}
$$
现在可以 $O(n)$ 计算了。

上述推导的核心在于 $\exp x-1$ 没有常数项，这是关键的一步观察。不过，我们并不知道上面的处理里还有没有别的关键步骤——现在让我们考虑第二个问题。

让我们看看如何 $O(n)$ 求出 $[\frac{z^n}{n!}]\frac{1}{1-2(\exp z-1)}$ 。类似的，我们发现我们可以截断到 $\sum_{i\le n}2^i(\exp z-1)^i$，这里依然具有封闭形式：令 $u=\exp z$，我们就得到 $\frac{1-2^{n+1}(u-1)^{n+1}}{3-2u}$。现在对 $e^{ix}$ 的系数递推是容易的了。

于是我们便发现：我们的做法是先写出多项式 $F(x)$，其中自变量 $x$ 对应的是 $\exp z-1$。这使得我们可以对其进行截断，而不破坏其封闭性，再令 $G(x+1)=F(x)$（换言之，找到 $G$ 满足 $G(\exp z)=F(\exp z-1)$），此时 $G$ 即为将 $F$ 中 $x$ 全部替换成 $x-1$ 后对应的多项式，这并未破坏原本分式的封闭性，而此时的 $x$ 对应 $\exp z$，递推是容易的。 

现在让我们来处理第三个问题。

我们要 $O(n)$ 求出 $[\frac{z^n}{n!}]\sum_{i\ge 0}F_i(\exp z-1)$，其中 $F_i$ 是第 $i$ 个斐波那契数。类似的，我们要做的是对 $\frac{1}{1-x-x^2}$ 进行截断。考虑设 $F_0(x)=\frac{1}{1-x-x^2}\mod x^n$，观察 $F_0(x)\times (1-x-x^2)$ 的结果，注意到当 $i<n$ 时，$x^i$ 之间的抵消关系是正确的，而当 $i>n+2$ 时，各项均为 $0$，这之间的关系也是正确的。只有 $i=n+1,n+2$ 的时候会出现一点问题。于是我们知道 $F_0(x)\times (1-x-x^2)=1+ux^{n+1}+vx^{n+2}$，并且我们容易得到 $u=-F_n-F_{n-1},v=-F_n$，于是我们得到 $F_0=\frac{1-(F_n+F_{n-1})x^{n+1}-F_nx^{n+2}}{1-x-x^2}$，代入 $u=x+1$，我们便可以正常递推。

至此，我们完成了对一般的有理分式结构，即线性递推数列的处理。现在让我们尝试扩展到正式递推上：回到前面的 ```Binomial Sum``` 问题。

我们要解决的是 $[\frac{z^n}{n!}](1+\exp z)^k$。根据上面的经验，我们先拆成 $(2+(\exp z-1))^k$，于是我们只需要计算 $(2+x)^k\bmod x^{n+1}$。考虑 $F(x)=(2+x)^k$ 满足的微分方程，我们就得到 $F'(2+x)=kF$，于是其系数有递推 $2(i+1)f_{i+1}+(i-k)f_i=0$，同样的，令 $F_0=F\bmod x^{n+1}$，前面的递推关系仅会在 $i=n$ 处出现问题，于是我们只需要修正 $x^n$ 项：我们就得到 $F_0'(2+x)-kF_0=(n-k)2^{k-n}{k]\choose n}x^n$。

这是关于 $\exp z-1$ 的方程，将其中的 $x$ 整体还原成 $x-1$，也就是构造 $G(x)=F_0(x-1)$，我们就会发现 $G(x)$ 满足 $G’(1+x)-kG=(n-k)2^{k-n}{k\choose n}(x-1)^n$，提取系数之后两边递推是容易的：我们就以 $O(n)$ 时间解决了上述问题。

### 一般做法

若我们有 $\sum_{i=0}^mP_i(n)f_{n-i}=0$，也就是对于微分方程的形式而言有 $\sum_{i=0}^kQ_i(x)F^{(i)}(x)=0$，计算 $F(\exp(z))$ 的第一步是将其化为关于 $\exp z-1$ 的式子后进行截断，也就是计算 $F(x+1)\bmod x^{n+1}$，那么我们可以将微分方程整体换元，得到 $\sum_{i=0}^kQ_i(x+1)F^{(i)}(x+1)$，而后我们会得到一个 $n+k$ 次的扰动多项式 $D(x)$，对应截断时无法抵消的部分，于是我们有 $\sum_{i=0}^kQ_i(x+1)F_0^{(i)}(x+1)=D(x)$，带回 $x-1$，我们得到 $\sum_{i=0}^kQ_i(x)F_0^{(i)}(x)=D(x-1)$，若整式递推具有常数项，且各步运算均可视为常数，我们便可在 $O(n)$ 时间之内递推得到 $F_0(x)$ 的各项系数，从而解决问题。

这一做法不仅对 $\exp z$ 的复合适用，对于一般的函数 $K(z)$，只需要将常数项清除，也就是计算 $F(x+K(0))$ 截断的结果即可。

再回到一开始的 $\sum_xf_xp(x)$，如果我们已知 $p(x)$ 在 $0,\cdots,n$ 处的点值，我们便可以如下计算：

- 改为 $\sum_xf_x\sum_ip_ix^i$，再改为 $\sum_ip_i\sum_xf_xx^i$，后面的部分是我们所熟悉的，假如我们已经得到 $g_i=[x^i]F_0(x)$，我们就只需要计算 $\sum_ip_i\sum_jj^ig_j$，再次交换求和号，我们有 $\sum_j\sum_ip_ij^ig_j$，也就是 $\sum_jp(j)g_j$。

这样我们就 $O(n)$ 解决了目标问题，鉴于输入的规模是 $O(n)$，我们得到了理论下界。

### 例题

- [CF932E](https://www.luogu.com.cn/problem/CF932E)
- [CF392C](https://www.luogu.com.cn/problem/CF392C)
- [如何优雅地求和](https://uoj.ac/problem/269)
- [TJOI 求和](https://loj.ac/p/2058)